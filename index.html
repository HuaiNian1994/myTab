<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Hi~~</title>
	<base target="_self"><!-- 所有链接默认在本页面打开 -->
	<link rel="icon" href="images/myIcon.png">
	<link rel="stylesheet" href="css/reset.css">
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="independent_modules/weather/weather.css">
</head>

<body style="opacity: 0">
	<header>
		<aside id="independent">
			<span id="clock"></span>
			<aside id="weather">
				<span id="paint">&#xe9ba;</span>
				<span id="temperature">0℃</span>
				<span id="state"> Loading...</span>
			</aside>
		</aside>
		<form id="search_father" action="https://www.google.com/search?" method="get">
			<span>&#xe8f0;</span>
			<ul class="engines"></ul>
			<!-- 想要提交表单，要为相应元素设置name属性，控制键的生成。否则无法生成键值对中的键 -->
			<input type="text" id="search" autocomplete="off" name="q" placeholder="What do you want...?">
		</form>
	</header>

	<div class="content">
		<ul id="links">
			<li>
				<div class="addLink">&#xe6ca;</div>
			</li>
		</ul>
	</div>
	<div class="processBar">
		<div class="processBarButton"></div>
	</div>

</body>
<script>
	//*****************************************元素节点*****************************************
	var enginesNode = document.getElementsByClassName("engines")[0];
	var search_fatherNode = document.getElementById("search_father");
	var linksNode = document.getElementById("links");
	var links_LiNodes = linksNode.getElementsByTagName("li");
	var addLinkNode = document.getElementsByClassName("addLink")[0];


	//*****************************************常量*****************************************
	const defaultHrefs = {
		LeetCode: {
			URL: "https://leetcode-cn.com/",
			style: "background:url('images/LeetCode.png') 50% 50%/cover;"
		},
		MDN: {
			URL: "https://developer.mozilla.org/zh-CN/",
			style: "background:url('images/MDN.png') 50% 50%/cover;"
		},
		baidu: {
			URL: "https://www.baidu.com",
			style: "background:url('images/baidu.png') 50% 50%/cover;"
		},
		github: {
			URL: "https://github.com/",
			style: "background:url('images/github.png') 50% 50%/cover;"
		},
		google: {
			URL: "https://www.google.com/ncr",
			style: "background: url('images/google.png') 50% 50% / cover;"
		},
		runoob: {
			URL: "http://www.runoob.com/",
			style: "background:url('images/runoob.png') 50% 50%/cover;"
		},
		w3school: {
			URL: "http://www.w3school.com.cn/",
			style: "background:url('images/w3school.png') 50% 50%/cover;"
		},
		wechat_public_platform: {
			URL: "https://mp.weixin.qq.com/",
			style: "background:url('images/wechat public platform.png') 50% 50%/cover;"
		}

	}
	const engineList = {
		Bing: "&#xe9ac;",
		Yahoo: "&#xe61a;",
		baidu: "&#xe6b6;",
		github: "&#xe709;",
		google: "&#xe8f0;",
		wikipedia: "&#xe673;",
		sogou: "&#xe8c9;",
		mozilla: "&#xeccf;",
		duckduckgo: "&#xe62e;"
	}
	const searchLinks = {
		Bing: {
			link: "https://cn.bing.com/search?",
			query: "q"
		},
		Yahoo: {
			link: "https://us.search.yahoo.com/yhs/search?",
			query: "p"
		},
		baidu: {
			link: "https://www.baidu.com/s?",
			query: "wd"
		},
		github: {
			link: "https://github.com/search?",
			query: "q"
		},
		google: {
			link: "https://www.google.com/search?",
			query: "q"
		},
		wikipedia: {
			link: "https://en.wikipedia.org/wiki/Special:Search?",
			query: "search"
		},
		sogou: {
			link: "https://www.sogou.com/web?",
			query: "query"
		},
		mozilla: {
			link: "https://developer.mozilla.org/zh-CN/search?",
			query: "q"
		},
		duckduckgo: {
			link: "https://duckduckgo.com/?",
			query: "q"
		}
	}




	//*****************************************变量*****************************************
	var setLinkTimer = [];
	var haveLinkMask = [];
	var lastHoverA = null;
	var INDEX = 0;

	//*****************************************封装函数****************************************
	var removeNode = aim => { //删除节点
		aim.parentNode.removeChild(aim);
	}
	var createSettingNode = father => { //创建设置选项
		var setLinkNode = document.createElement("span");
		setLinkNode.className = "setLink"
		setLinkNode.innerHTML = "&#xe645;"
		father.appendChild(setLinkNode);
	}
	var addLinkMask = node => { //linkMask作谁的兄弟，就传入谁
		var valueString = "",
			URLString = "";
		if (node.tagName == "A") {
			valueString = "value=" + node.getAttribute("siteName");
			URLString = "value=" + node.getAttribute("href");
		}
		var linkMask = document.createElement("div");
		linkMask.className = "linkMask"
		linkMask.innerHTML =
			`<div><label>Name</label><input ${valueString} placeholder="Input site name"></input></div><div><label>URL</label><input ${URLString} placeholder="Begin with https://"></input></div><div><aside class=\"quit\">&#xe6c9;</aside><aside class=\"clear\">&#xe70a;</aside><aside class=\"done\">&#xe7b7;</aside></div>`;
		node.parentNode.appendChild(linkMask);
		haveLinkMask[parseInt(node.getAttribute("index"))] = true;
		setTimeout(() => {
			node.parentNode.getElementsByClassName("linkMask")[0].style.opacity = 1;
		}, 100);
	}


	//*****************************************页面初始化*****************************************
	window.onload = () => {
		//创建书签列表
		for (key in defaultHrefs) {
			var liNode = document.createElement("li");
			var aNode = document.createElement("a");
			aNode.setAttribute("href", defaultHrefs[key].URL);
			aNode.setAttribute("style", defaultHrefs[key].style);
			aNode.setAttribute("index", INDEX++);
			aNode.setAttribute("siteName", key);
			aNode.className = "customLink";
			liNode.appendChild(aNode);
			linksNode.insertBefore(liNode, addLinkNode.parentNode);
			setLinkTimer.push(null);
			haveLinkMask.push(false);
		}
		addLinkNode.setAttribute("index", INDEX);

		//创建搜索图标列表
		for (key in engineList) {
			var node = document.createElement("li");
			node.setAttribute("engineName", key)
			node.innerHTML = engineList[key]
			node.className = "enginePic"
			enginesNode.appendChild(node);
		}
		//记录搜索引擎选择历史
		var enginename = null;
		if (enginename = localStorage.getItem("selectedEngineName")) {
			search_fatherNode.action = searchLinks[enginename].link;
			glass.innerHTML = engineList[enginename]
			search_fatherNode.children[2].name = searchLinks[enginename].query;
		}
		//加载时页面淡入
		document.getElementsByTagName("body")[0].style.opacity = 1;
	}








	//*****************************************业务逻辑*****************************************

	//搜索引擎更换功能
	enginesNode.onclick = (e) => {
		if (e.target.className == "enginePic") {
			var engineName = e.target.getAttribute("enginename");
			search_fatherNode.action = searchLinks[engineName].link;
			glass.innerHTML = engineList[engineName]
			search_fatherNode.children[2].name = searchLinks[engineName].query;
			localStorage.setItem("selectedEngineName", engineName)
		}
	}
	//设定搜索引擎更换动画效果
	var glass = search_fatherNode.children[0];
	var timer = null;
	glass.onmouseover = () => {
		glass.style.color = "white";
	}
	glass.onclick = () => {
		enginesNode.style.opacity = 1;
		enginesNode.style.transform = "scaleX(1)";
	}
	glass.onmouseout = () => {
		glass.style.color = "rgb(155, 155, 155)";
		timer = setTimeout(() => {
			enginesNode.style.opacity = 0;
			enginesNode.style.transform = "scaleX(0)";
		}, 500);
	}
	enginesNode.onmouseover = () => {
		clearTimeout(timer);
		enginesNode.style.opacity = 1;
		enginesNode.style.transform = "scaleX(1)";
		glass.style.color = "white";
	}
	enginesNode.onmouseout = () => {
		glass.style.color = "rgb(155, 155, 155)";
		timer = setTimeout(() => {
			enginesNode.style.opacity = 0;
			enginesNode.style.transform = "scaleX(0)";
		}, 500);
	}





	//书签添加功能
	addLinkNode.onclick = e => {
		addLinkMask(e.target)
	}


	//书签设置按钮动画
	linksNode.onmouseover = (e) => {
		if (e.target.tagName == "A") {
			if (e.target.children[0] === undefined) {
				createSettingNode(e.target);
			}
			if (e.target == lastHoverA) { //继续显示setLink按钮
				clearInterval(setLinkTimer[parseInt(e.target.getAttribute("index"))]);
			} else {
				lastHoverA = e.target;
			}
			e.target.children[0].style.cssText = "transform:scale(1)";
		}
		if (e.target.className == "setLink") { //继续显示setLink按钮
			var index = parseInt(e.target.parentNode.getAttribute("index"));
			clearInterval(setLinkTimer[index]);
		}
	}


	linksNode.onmouseout = (e) => {
		if (e.target.tagName == "A") {
			setLinkTimer[parseInt(e.target.getAttribute("index"))] = setTimeout(() => {
				e.target.children[0].style.cssText = "transform:scale(0)"
			}, 200);
		}
		if (e.target.className == "setLink") {
			e.target.style.cssText = "transform:scale(0)"
		}
	}

	//书签设置功能
	linksNode.onclick = (e) => {
		if (e.target.className == "setLink") { //点击设置按钮时
			e.preventDefault();
			if (haveLinkMask[parseInt(e.target.parentNode.getAttribute("index"))] == false) {
				addLinkMask(e.target.parentNode);
			}
		} else if (e.target.tagName == "ASIDE") {
			var thisLinkMask = e.target.parentNode.parentNode;
			var thisLinkMask_Name = thisLinkMask.children[0].children[1];
			var thisLinkMask_URL = thisLinkMask.children[1].children[1];

			if (e.target.className == "clear") { //清空按钮
				thisLinkMask_URL.value = "";
				thisLinkMask_Name.value = "";
			} else if (e.target.className == "done") { //完成按钮
				if (thisLinkMask_URL.value.replace(/\s/gi, "") != "" && thisLinkMask_Name.value.replace(/\s/gi, "") !=
					"") { //如果输入不为空
					if (e.target.parentNode.parentNode.parentNode.children[0].tagName == "A") { //如果是为了更改书签
						thisLinkMask.parentNode.children[0].innerHTML = thisLinkMask_Name.value;
						thisLinkMask.parentNode.children[0].setAttribute("siteName", thisLinkMask_Name.value);
						thisLinkMask.parentNode.children[0].style.cssText = "background-color:rgba(255,255,255,0.8)";
						thisLinkMask.parentNode.children[0].setAttribute("href", thisLinkMask_URL.value);
						haveLinkMask[parseInt(thisLinkMask.parentNode.children[0].getAttribute("index"))] = false;
						removeNode(thisLinkMask);
					} else { //如果是为了添加书签
						var liNode = document.createElement("li");
						var aNode = document.createElement("a");
						aNode.setAttribute("href", thisLinkMask_URL.value);
						aNode.setAttribute("style", "background-color:rgba(255,255,255,0.8)");
						aNode.setAttribute("index", INDEX++);
						aNode.setAttribute("siteName", thisLinkMask_Name.value);
						aNode.className = "customLink";
						aNode.innerHTML = thisLinkMask_Name.value;
						liNode.appendChild(aNode);
						linksNode.insertBefore(liNode, addLinkNode.parentNode);
						setLinkTimer.push(null);
						haveLinkMask.push(false);
						haveLinkMask[parseInt(thisLinkMask.parentNode.children[0].getAttribute("index"))] = false;
						addLinkNode.setAttribute("index", INDEX);
						removeNode(thisLinkMask);
					}
				}
			} else if (e.target.className == "quit") { //退出按钮
				haveLinkMask[parseInt(thisLinkMask.parentNode.children[0].getAttribute("index"))] = false;
				removeNode(thisLinkMask);
			}

		}
	}
</script>
<script src="independent_modules/clock/clock.js"></script>
<script src="independent_modules/weather/weather.js"></script>

</html>